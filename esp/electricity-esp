##include <WiFi.h>    // Wi-Fiæ¥ç¶šç”¨
#include <time.h>    // æ™‚åˆ»å–å¾—ç”¨ï¼ˆNTPï¼‰
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Preferences.h>  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªä¿å­˜ç”¨
#include <Wire.h>         // I2Cé€šä¿¡ç”¨
#include <BH1750.h>       // BH1750ã‚»ãƒ³ã‚µãƒ¼ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

// Preferencesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
Preferences preferences;

// BH1750ã‚»ãƒ³ã‚µãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
BH1750 lightMeter;

// ã‚»ãƒ³ã‚µãƒ¼æ¥ç¶šãƒ”ãƒ³
const int PIN_PIR = 27;   // äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼ï¼ˆPIRï¼‰
// BH1750ã¯I2Cã§æ¥ç¶šï¼ˆSDA: GPIO21, SCL: GPIO22ï¼‰

// æ˜ã‚‹ã•åˆ¤å®šç”¨ï¼ˆãƒ«ã‚¯ã‚¹å€¤ï¼‰- ã‚ˆã‚Šå³å¯†ãªè¨­å®š
const float LUX_FLUORESCENT_ON  = 150.0;    // è›å…‰ç¯ç‚¹ç¯æ™‚ã®æœ€ä½å€¤
const float LUX_FLUORESCENT_OFF = 100.0;    // è›å…‰ç¯æ¶ˆç¯æ™‚ã®æœ€å¤§å€¤
const float LUX_SUNLIGHT_MAX = 1000.0;      // å¤ªé™½å…‰åˆ¤å®šä¸Šé™ï¼ˆã“ã‚Œä»¥ä¸Šã¯å¤ªé™½å…‰ã¨åˆ¤æ–­ï¼‰
const float LIGHT_POWER_W = 40.0;           // é›»çƒã®æ¶ˆè²»é›»åŠ›[W]

// è›å…‰ç¯çŠ¶æ…‹ç®¡ç†
bool isFluorescentOn = false;               // è›å…‰ç¯ã®çŠ¶æ…‹ï¼ˆã‚ˆã‚Šå³å¯†ãªåˆ¤å®šï¼‰
unsigned long lastLightChangeMs = 0;        // ç…§æ˜çŠ¶æ…‹å¤‰æ›´æ™‚åˆ»
const unsigned long LIGHT_STABLE_MS = 3000; // ç…§æ˜çŠ¶æ…‹å®‰å®šåŒ–æ™‚é–“ï¼ˆ3ç§’ï¼‰

// æ¸¬å®šç”¨å¤‰æ•°
bool isBright = false;            // æ˜ã‚‹ã•ã®çŠ¶æ…‹
bool measuring = false;           // æ¸¬å®šä¸­ã‹ã©ã†ã‹(æ¸¬å®šä¸­ãªã‚‰true)
unsigned long measureStart = 0;   // æ¸¬å®šé–‹å§‹æ™‚åˆ»(measuring = trueã§é–‹å§‹
unsigned long wastedMs = 0;       // 1æ—¥ã®ç„¡é§„ç‚¹ç¯æ™‚é–“[ms]
unsigned long hourlyMs = 0;       // 1æ™‚é–“ã”ã¨ç”¨

double dailyTotalKWh = 0;         // 1æ—¥ã®ç„¡é§„é›»åŠ›åˆè¨ˆ[kWh]
unsigned long dailyTotalMs = 0;   // 1æ—¥ã®ç„¡é§„æ™‚é–“åˆè¨ˆ[ms]

// æ™‚åˆ»ç®¡ç†ç”¨å¤‰æ•°
int lastHour = -1;                // å‰å›ã®æ™‚é–“ï¼ˆ0~23ï¼‰ã‚’è¨˜éŒ²
int lastDay  = -1;                // å‰å›ã®æ—¥ï¼ˆ1~31ï¼‰ã‚’è¨˜éŒ²

// äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼å®‰å®šåŒ–ï¼ˆèª¿æ•´ã•ã‚ŒãŸå€¤ï¼‰
const unsigned long PIR_STABLE_MS = 50;   // 50[ms]ä»¥ä¸Šå¤‰åŒ–ãŒãªã‘ã‚Œã°ç¢ºå®šï¼ˆçŸ­ç¸®ï¼‰
unsigned long lastPirChangeMs = 0;        // å¤‰åŒ–ãŒã‚ã£ãŸæ™‚åˆ»ã®è¨˜éŒ²
int lastPirRaw = LOW;                     // å¤‰åŒ–ãŒã‚ã£ãŸã‹ç¢ºèª
int pirState = LOW;                       // 50[ms]å¤‰åŒ–ãªã— pirState = HIGH

// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ–¹å¼ç”¨å¤‰æ•°
bool personPresent = false;               // äººã®åœ¨å®¤çŠ¶æ…‹
unsigned long lastPersonDetectedMs = 0;   // æœ€å¾Œã«äººã‚’æ¤œçŸ¥ã—ãŸæ™‚åˆ»
const unsigned long PERSON_TIMEOUT_MS = 600000; // 10åˆ†é–“æ¤œçŸ¥ãŒãªã„ã¨ä¸åœ¨ã¨ã¿ãªã™ï¼ˆ600,000ms = 10åˆ†ï¼‰
bool personTimeoutEnabled = true;         // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã®ON/OFF

// ãƒ‡ãƒãƒƒã‚°ç”¨å¤‰æ•°
bool debugMode = true;                    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ON/OFF
unsigned long lastPirDebugMs = 0;         // PIRãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ç”¨ã‚¿ã‚¤ãƒãƒ¼

// æ™‚åˆ»ç®¡ç†ç”¨ã€€å‰å›ã®æ™‚åˆ»ã‚’è¨˜éŒ²(-1 :åˆæœŸå€¤)
int lastFiveMin = -1;  // æ™‚é–“å˜ä½0~23ã‚’è¨˜éŒ²ã€€nowHourå¤‰åŒ–23ã‹ã‚‰0:æ–°ã—ã„æ™‚é–“ã«ã™ã‚‹

// Wi-Fiè¨­å®š
const char* WIFI_SSID     = "TK";
const char* WIFI_PASSWORD = "Tsujimotokentowifi";

// NTPè¨­å®š æ™‚åˆ»åŒæœŸ
const char* ntpServer = "ntp.nict.jp";  // æ­£ã—ã„ä¸–ç•Œæ™‚åˆ»å–å¾—
const long  gmtOffset_sec = 9*3600;     // 32400[s]=åŸºæº–æ™‚ã‹ã‚‰+9æ™‚é–“ã§æ—¥æœ¬æ¨™æº–æ™‚é–“ã«åˆã‚ã›ã‚‹
const int   daylightOffset_sec = 0;     // ã‚µãƒãƒ¼ã‚¿ã‚¤ãƒ èª¿æ•´(å¤ã¯æ™‚è¨ˆã‚’ä¸€æ™‚é–“æ—©ã‚ã‚‹å›½ãŒã‚ã‚‹)

// ç™»éŒ²ã‚³ãƒ¼ãƒ‰ç™»éŒ²
String registrationCode = "";
String deviceId = "";

// ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹IDã‚’èª­ã¿è¾¼ã¿
String loadDeviceId() {
  preferences.begin("device", false);  // åå‰ç©ºé–“"device"ã§èª­ã¿æ›¸ããƒ¢ãƒ¼ãƒ‰ã§é–‹ã
  String storedDeviceId = preferences.getString("deviceId", "");
  preferences.end();
  return storedDeviceId;
}

String loadRegistrationId() {
  preferences.begin("device", false);  // åå‰ç©ºé–“"device"ã§èª­ã¿æ›¸ããƒ¢ãƒ¼ãƒ‰ã§é–‹ã
  String storedRegistrationId = preferences.getString("registrationId", "");
  preferences.end();
  return storedRegistrationId;
}

// ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªã«ãƒ‡ãƒã‚¤ã‚¹IDã‚’ä¿å­˜
void saveDeviceId(String devId, String registrationId) {
  preferences.begin("device", false);  // åå‰ç©ºé–“"device"ã§èª­ã¿æ›¸ããƒ¢ãƒ¼ãƒ‰ã§é–‹ã
  preferences.putString("deviceId", devId);
  preferences.putString("registrationId", registrationId);
  preferences.end();
  Serial.println("ãƒ‡ãƒã‚¤ã‚¹IDä¿å­˜å®Œäº†: " + devId);
}

// BH1750ç…§åº¦ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–
bool initBH1750() {
  Wire.begin();  // I2CåˆæœŸåŒ–
  
  if (lightMeter.begin()) {
    Serial.println("BH1750ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–æˆåŠŸ");
    return true;
  } else {
    Serial.println("BH1750ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–å¤±æ•—");
    return false;
  }
}

// BH1750ã‹ã‚‰ç…§åº¦å€¤ã‚’èª­ã¿å–ã‚Šï¼ˆå¹³å‡åŒ–ã§ãƒã‚¤ã‚ºå¯¾ç­–ï¼‰
float readLux(int n = 5) {
  float sum = 0;
  int validReadings = 0;
  
  for(int i = 0; i < n; i++) {
    float lux = lightMeter.readLightLevel();
    if (lux >= 0) {  // æ­£å¸¸ãªèª­ã¿å–ã‚Šå€¤ã®å ´åˆ
      sum += lux;
      validReadings++;
    }
    delay(50);  // æ¸¬å®šé–“éš”
  }
  
  if (validReadings > 0) {
    return sum / validReadings;
  } else {
    Serial.println("ç…§åº¦ã‚»ãƒ³ã‚µãƒ¼èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼");
    return -1;
  }
}

// è›å…‰ç¯çŠ¶æ…‹æ›´æ–°ï¼ˆã‚ˆã‚Šå³å¯†ãªåˆ¤å®šï¼‰
void updateBrightness() {
  float lux = readLux();
  
  if (lux < 0) {
    // ã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯çŠ¶æ…‹ã‚’å¤‰æ›´ã—ãªã„
    return;
  }
  
  bool oldFluorescentState = isFluorescentOn;
  
  // å¤ªé™½å…‰ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ã¾ã‚Šã«ã‚‚æ˜ã‚‹ã„å ´åˆã¯å¤ªé™½å…‰ã¨åˆ¤æ–­ï¼‰
  if (lux > LUX_SUNLIGHT_MAX) {
    if (debugMode && isFluorescentOn) {
      Serial.printf("[LIGHT] å¤ªé™½å…‰æ¤œå‡º: %.1f lux (è›å…‰ç¯åˆ¤å®šã‚’ç„¡åŠ¹åŒ–)\n", lux);
    }
    isFluorescentOn = false;  // å¤ªé™½å…‰ã®å ´åˆã¯è›å…‰ç¯OFFã¨ã¿ãªã™
    lastLightChangeMs = millis();
    return;
  }
  
  // ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹åˆ¶å¾¡ã§è›å…‰ç¯ã®ç‚¹ç¯/æ¶ˆç¯ã‚’åˆ¤å®š
  if (!isFluorescentOn && lux >= LUX_FLUORESCENT_ON) {
    isFluorescentOn = true;
    lastLightChangeMs = millis();
    Serial.printf("[LIGHT] è›å…‰ç¯ç‚¹ç¯æ¤œå‡º: %.1f lux\n", lux);
  }
  else if (isFluorescentOn && lux <= LUX_FLUORESCENT_OFF) {
    isFluorescentOn = false;
    lastLightChangeMs = millis();
    Serial.printf("[LIGHT] è›å…‰ç¯æ¶ˆç¯æ¤œå‡º: %.1f lux\n", lux);
  }
  
  // çŠ¶æ…‹ãŒå¤‰åŒ–ã—ãŸå ´åˆã®è©³ç´°ãƒ­ã‚°
  if (oldFluorescentState != isFluorescentOn && debugMode) {
    Serial.printf("[LIGHT] è›å…‰ç¯çŠ¶æ…‹å¤‰æ›´: %s -> %s (%.1f lux)\n",
                  oldFluorescentState ? "ON" : "OFF",
                  isFluorescentOn ? "ON" : "OFF",
                  lux);
  }
}

// äººæ„Ÿã‚»ãƒ³ã‚µæ›´æ–° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ–¹å¼+ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
void updatePir() {
  int raw = digitalRead(PIN_PIR);                    // äººæ„Ÿã‚»ãƒ³ã‚µã‹ã‚‰ã®ãã®ã¾ã¾ã®å€¤
  
  // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ï¼ˆ5ç§’ã”ã¨ã«è©³ç´°çŠ¶æ…‹ã‚’è¡¨ç¤ºï¼‰
  if(debugMode && millis() - lastPirDebugMs >= 5000) {
    lastPirDebugMs = millis();
    unsigned long timeSinceDetection = millis() - lastPersonDetectedMs;
    Serial.printf("[PIR DEBUG] Raw: %s, Stable: %s, Person: %s, æœ€çµ‚æ¤œçŸ¥: %luç§’å‰\n", 
                  raw == HIGH ? "HIGH" : "LOW",
                  pirState == HIGH ? "HIGH" : "LOW",
                  personPresent ? "åœ¨å®¤" : "ä¸åœ¨",
                  timeSinceDetection / 1000);
    
    if (personTimeoutEnabled && personPresent && timeSinceDetection > PERSON_TIMEOUT_MS / 2) {
      Serial.printf("[PIR WARNING] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§æ®‹ã‚Š: %luç§’\n", 
                    (PERSON_TIMEOUT_MS - timeSinceDetection) / 1000);
    }
  }
  
  if(raw != lastPirRaw) {                            // å¤‰åŒ–ãŒã‚ã£ãŸã‚‰
    lastPirRaw = raw;
    lastPirChangeMs = millis();                      // æ–°ã—ã„å€¤ã¨ãã®æ™‚åˆ»[ms]ã®ä¿å­˜
    if(debugMode) {
      Serial.printf("[PIR CHANGE] Raw: %s -> %s\n", 
                    pirState == HIGH ? "HIGH" : "LOW",
                    raw == HIGH ? "HIGH" : "LOW");
    }
  }
  
  if(millis() - lastPirChangeMs > PIR_STABLE_MS) {   // å€¤å¤‰åŒ–ã‹ã‚‰50[ms]çµŒã£ã¦ã„ãŸã‚‰
    if(pirState != raw) {  // çŠ¶æ…‹ãŒå®Ÿéš›ã«å¤‰ã‚ã‚‹æ™‚ã®ã¿å‡¦ç†
      int oldPirState = pirState;
      pirState = raw;                                // PIRçŠ¶æ…‹ã‚’æ›´æ–°
      
      // äººæ¤œçŸ¥æ™‚ï¼ˆLOW â†’ HIGHï¼‰
      if(oldPirState == LOW && pirState == HIGH) {
        lastPersonDetectedMs = millis();             // æœ€çµ‚æ¤œçŸ¥æ™‚åˆ»ã‚’æ›´æ–°
        
        if (!personPresent) {
          personPresent = true;                      // åœ¨å®¤çŠ¶æ…‹ã«å¤‰æ›´
          Serial.println("=====================================");
          Serial.println(">>> äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼æ¤œçŸ¥: åœ¨å®¤çŠ¶æ…‹ã«å¤‰æ›´ <<<");
          Serial.println("=====================================");
        } else {
          if(debugMode) {
            Serial.printf("[PIR] åœ¨å®¤çŠ¶æ…‹ã‚’å»¶é•·ï¼ˆæœ€çµ‚æ¤œçŸ¥æ™‚åˆ»ã‚’æ›´æ–°ï¼‰\n");
          }
        }
      }
    }
  }
  
  // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆäººãŒã„ã‚‹ã¯ãšãªã®ã«é•·æ™‚é–“æ¤œçŸ¥ã•ã‚Œãªã„å ´åˆï¼‰
  if (personTimeoutEnabled && personPresent && 
      (millis() - lastPersonDetectedMs) > PERSON_TIMEOUT_MS) {
    personPresent = false;
    Serial.println("=====================================");
    Serial.printf(">>> ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: %luåˆ†é–“æ¤œçŸ¥ã•ã‚Œãªã„ãŸã‚ä¸åœ¨çŠ¶æ…‹ã«å¤‰æ›´ <<<\n", 
                  PERSON_TIMEOUT_MS / 60000);
    Serial.println("=====================================");
  }
}

// msã‚’æ™‚:åˆ†:ç§’ã«å¤‰æ›
String formatTime(unsigned long ms) {
  unsigned long sec = ms/1000;
  unsigned int h = (sec/3600)%24;
  unsigned int m = (sec/60)%60;
  unsigned int s = sec%60;
  char buf[16];
  sprintf(buf,"%02u:%02u:%02u", h, m, s);
  return String(buf);
}

// æœˆæ—¥å‡ºåŠ›è¡¨ç¤ºå–å¾—
String getMonthDayKey(struct tm *timeinfo) {
  char buf[8];
  sprintf(buf,"%02d-%02d", timeinfo->tm_mon+1, timeinfo->tm_mday);
  return String(buf);
}

// ãƒ‡ãƒã‚¤ã‚¹ã®å­˜åœ¨ç¢ºèª
bool checkDeviceExists(String deviceId) {
  HTTPClient http;
  http.begin("https://aquariumotion.vercel.app/api/check-device-status");
  http.addHeader("Content-Type", "application/json");
  
  DynamicJsonDocument doc(1024);
  doc["deviceId"] = deviceId;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode == 200) {
    // ãƒ‡ãƒã‚¤ã‚¹ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
    http.end();
    return true;
  } else if (httpResponseCode == 404) {
    // ãƒ‡ãƒã‚¤ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆ
    http.end();
    return false;
  }
  
  // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
  http.end();
  return false;
}

// ãƒ‡ãƒã‚¤ã‚¹IDã‚’åˆæœŸåŒ–ï¼ˆä¿å­˜æ¸ˆã¿IDã‚’ä½¿ç”¨ã¾ãŸã¯æ–°è¦ç™»éŒ²ï¼‰
String initializeDeviceId(String deviceType) {
  // ã¾ãšä¿å­˜æ¸ˆã¿IDã‚’èª­ã¿è¾¼ã¿
  String storedId = loadDeviceId();
  String storedRegistrationId = loadRegistrationId();

  if (storedId != "") {
    // ä¿å­˜æ¸ˆã¿IDãŒã‚ã‚‹å ´åˆã€ã‚µãƒ¼ãƒãƒ¼ã§ç¢ºèª
    Serial.println("ä¿å­˜æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹IDæ¤œå‡º: " + storedId);
    if (checkDeviceExists(storedId)) {
      Serial.println("ãƒ‡ãƒã‚¤ã‚¹IDç¢ºèªå®Œäº†: " + storedId);
      registrationCode = storedRegistrationId;
      deviceId = storedId;
      return storedId;
    } else {
      Serial.println("ä¿å­˜æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹IDãŒã‚µãƒ¼ãƒãƒ¼ã«å­˜åœ¨ã—ã¾ã›ã‚“ã€‚æ–°è¦ç™»éŒ²ã—ã¾ã™ã€‚");
    }
  }
  
  // æ–°è¦ç™»éŒ²
  return registerDevice(deviceType);
}

String registerDevice(String deviceType) {
  HTTPClient http;
  http.begin("https://aquariumotion.vercel.app/api/register-device");
  http.addHeader("Content-Type", "application/json");
  
  DynamicJsonDocument doc(1024);
  doc["deviceType"] = deviceType;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode == 200) {
    String response = http.getString();
    DynamicJsonDocument responseDoc(1024);
    deserializeJson(responseDoc, response);
    
    String getDeviceId = responseDoc["data"]["deviceId"];
    String getRegistrationCode = responseDoc["data"]["registrationCode"];
    
    registrationCode = getRegistrationCode;
    deviceId = getDeviceId;

    saveDeviceId(deviceId, registrationCode);  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒªã«ä¿å­˜
    
    Serial.println("æ–°è¦ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²å®Œäº†");
    Serial.println("Device ID: " + deviceId);
    Serial.println("Registration Code: " + registrationCode);
    
    http.end();
    return deviceId;
  }
  
  http.end();
  return "";
}

bool sendUsageData(String deviceId, String usageType, float amount, String apiKey) {
  HTTPClient http;
  http.begin("https://aquariumotion.vercel.app/api/log-device-usage");
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  http.addHeader("Content-Type", "application/json");
  http.addHeader("x-api-key", apiKey);
  
  // JSONä½œæˆ
  DynamicJsonDocument doc(1024);
  doc["deviceId"] = deviceId;
  doc["usageType"] = usageType;
  doc["amount"] = amount;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  // POSTé€ä¿¡
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode == 200) {
    Serial.println("ãƒ‡ãƒ¼ã‚¿é€ä¿¡æˆåŠŸ");
    String response = http.getString();
    Serial.println("Response: " + response);
    http.end();
    return true;
  } else {
    Serial.println("é€ä¿¡å¤±æ•—: " + String(httpResponseCode));
    String errorResponse = http.getString();
    Serial.println("Error: " + errorResponse);
    http.end();
    return false;
  }
}

void factoryReset() {
    preferences.begin("device", false);
    preferences.clear();  // åå‰ç©ºé–“å†…ã®å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
    preferences.end();
    Serial.println("å·¥å ´å‡ºè·æ™‚è¨­å®šã«ãƒªã‚»ãƒƒãƒˆå®Œäº†");
}

void setup() {
  Serial.begin(115200);
  
  // PIRã‚»ãƒ³ã‚µãƒ¼ã®ãƒ”ãƒ³è¨­å®šï¼ˆãƒ—ãƒ«ã‚¢ãƒƒãƒ—æŠµæŠ—ã‚’æœ‰åŠ¹åŒ–ï¼‰
  pinMode(PIN_PIR, INPUT_PULLUP);
  
  // PIRã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–å¾…æ©Ÿï¼ˆã‚»ãƒ³ã‚µãƒ¼å®‰å®šåŒ–ã®ãŸã‚ï¼‰
  Serial.println("PIRã‚»ãƒ³ã‚µãƒ¼å®‰å®šåŒ–å¾…æ©Ÿä¸­...");
  delay(2000);  // 2ç§’å¾…æ©Ÿ
  
  // PIRã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸçŠ¶æ…‹ã‚’ç¢ºèª
  int initialPirState = digitalRead(PIN_PIR);
  Serial.printf("PIRã‚»ãƒ³ã‚µãƒ¼åˆæœŸçŠ¶æ…‹: %s\n", initialPirState == HIGH ? "HIGH" : "LOW");

  Serial.println("=== ç„¡é§„ç‚¹ç¯ãƒ­ã‚¬ãƒ¼é–‹å§‹ ===");

  // BH1750ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–
  if (!initBH1750()) {
    Serial.println("ç…§åº¦ã‚»ãƒ³ã‚µãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’åœæ­¢ã—ã¾ã™ã€‚");
    while(1);  // åœæ­¢
  }

  // Wi-Fiæ¥ç¶š 
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("WiFi connecting");
  while(WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println(" connected!");
  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
  initializeDeviceId("electricity");  // å›ºå®šãƒ‡ãƒã‚¤ã‚¹IDåˆæœŸåŒ–
  
  Serial.printf("ç…§åº¦åˆ¤å®šè¨­å®š:\n");
  Serial.printf("  è›å…‰ç¯ç‚¹ç¯åˆ¤å®š: %.1f luxä»¥ä¸Š\n", LUX_FLUORESCENT_ON);
  Serial.printf("  è›å…‰ç¯æ¶ˆç¯åˆ¤å®š: %.1f luxä»¥ä¸‹\n", LUX_FLUORESCENT_OFF);
  Serial.printf("  å¤ªé™½å…‰é™¤å¤–: %.1f luxä»¥ä¸Šã¯å¤ªé™½å…‰ã¨åˆ¤æ–­\n", LUX_SUNLIGHT_MAX);
  Serial.printf("  çŠ¶æ…‹å®‰å®šåŒ–: %lu ms\n", LIGHT_STABLE_MS);
  Serial.printf("PIRè¨­å®š: å®‰å®šåŒ–æ™‚é–“ %lu ms\n", PIR_STABLE_MS);
  Serial.println("==== äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ–¹å¼ ====");
  Serial.println("  äººæ¤œçŸ¥ â†’ åœ¨å®¤çŠ¶æ…‹ã«å¤‰æ›´");
  Serial.printf("  %luåˆ†é–“æ¤œçŸ¥ãªã— â†’ è‡ªå‹•çš„ã«ä¸åœ¨çŠ¶æ…‹\n", PERSON_TIMEOUT_MS / 60000);
  Serial.println("  ã‚ˆã‚Šå®‰å®šã§è‡ªç„¶ãªå‹•ä½œ");
  Serial.println("==== æ¸¬å®šæ¡ä»¶: å³å¯†ãƒ¢ãƒ¼ãƒ‰ ====");
  Serial.println("  âœ… äººãŒä¸åœ¨çŠ¶æ…‹");
  Serial.println("  âœ… è›å…‰ç¯ãŒç‚¹ç¯çŠ¶æ…‹");
  Serial.println("  âœ… ç…§æ˜çŠ¶æ…‹ãŒå®‰å®šï¼ˆ3ç§’ä»¥ä¸Šå¤‰åŒ–ãªã—ï¼‰");
  Serial.println("  âŒ å¤ªé™½å…‰ã¯é™¤å¤–");
  Serial.println("==== ãƒ‡ãƒ¼ã‚¿é€ä¿¡: 1æ™‚é–“ã”ã¨ ====");
  Serial.println("  ğŸ“Š é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ç„¡é§„ãªç§’æ•°");
  Serial.println("  â° é€ä¿¡é–“éš”: æ¯æ™‚é–“");
  Serial.println("ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒãƒ³ãƒ‰:");
  Serial.println("  'd' : ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ON/OFF");
  Serial.println("  't' : æ‰‹å‹•ã§åœ¨å®¤çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«");
  Serial.println("  'l' : æ‰‹å‹•ã§è›å…‰ç¯çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«");
  Serial.println("  'o' : ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ON/OFF");
  Serial.println("  'r' : äººã®åœ¨å®¤çŠ¶æ…‹ã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ");
  Serial.println("=====================================");
}

void loop() {
  updateBrightness();
  updatePir();

  // ã‚·ãƒªã‚¢ãƒ«å…¥åŠ›ã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
  if (Serial.available() > 0) {
    char input = Serial.read();
    if (input == 'd' || input == 'D') {
      debugMode = !debugMode;
      Serial.printf("ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: %s\n", debugMode ? "ON" : "OFF");
    }
    // æ‰‹å‹•ã§äººã®çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
    else if (input == 't' || input == 'T') {
      personPresent = !personPresent;
      if (personPresent) {
        lastPersonDetectedMs = millis(); // åœ¨å®¤ã«ã™ã‚‹å ´åˆã¯æ¤œçŸ¥æ™‚åˆ»ã‚‚æ›´æ–°
      }
      Serial.println("=====================================");
      Serial.printf(">>> æ‰‹å‹•å¤‰æ›´: äººã®çŠ¶æ…‹ãŒã€Œ%sã€ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ <<<\n", 
                    personPresent ? "åœ¨å®¤" : "ä¸åœ¨");
      Serial.println("=====================================");
    }
    // æ‰‹å‹•ã§è›å…‰ç¯çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
    else if (input == 'l' || input == 'L') {
      isFluorescentOn = !isFluorescentOn;
      lastLightChangeMs = millis();
      Serial.println("=====================================");
      Serial.printf(">>> æ‰‹å‹•å¤‰æ›´: è›å…‰ç¯çŠ¶æ…‹ãŒã€Œ%sã€ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸ <<<\n", 
                    isFluorescentOn ? "ç‚¹ç¯" : "æ¶ˆç¯");
      Serial.println("=====================================");
    }
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã®ON/OFF
    else if (input == 'o' || input == 'O') {
      personTimeoutEnabled = !personTimeoutEnabled;
      Serial.printf("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½: %s\n", personTimeoutEnabled ? "æœ‰åŠ¹" : "ç„¡åŠ¹");
      if (personTimeoutEnabled) {
        Serial.printf("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“: %luåˆ†\n", PERSON_TIMEOUT_MS / 60000);
      }
    }
    // äººã®åœ¨å®¤çŠ¶æ…‹ã‚’å¼·åˆ¶ãƒªã‚»ãƒƒãƒˆ
    else if (input == 'r' || input == 'R') {
      personPresent = false;
      Serial.println("äººã®åœ¨å®¤çŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«ä¸åœ¨ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    }
    // å…¥åŠ›ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢
    while(Serial.available() > 0) Serial.read();
  }

  // è›å…‰ç¯çŠ¶æ…‹ã®å®‰å®šåŒ–ãƒã‚§ãƒƒã‚¯
  bool lightStateStable = (millis() - lastLightChangeMs) > LIGHT_STABLE_MS;
  
  // å³å¯†ãªæ¸¬å®šæ¡ä»¶: äººä¸åœ¨ ï¼† è›å…‰ç¯ç‚¹ç¯ ï¼† çŠ¶æ…‹å®‰å®š
  bool shouldMeasure = (!personPresent && isFluorescentOn && lightStateStable);

  // æ¸¬å®šé–‹å§‹/åœæ­¢
  if(shouldMeasure && !measuring) {
    measuring = true;
    measureStart = millis();
    Serial.println("=====================================");
    Serial.println(">>> ç„¡é§„ç‚¹ç¯æ¸¬å®šé–‹å§‹ <<<");
    Serial.println("æ¡ä»¶: äººä¸åœ¨ ï¼† è›å…‰ç¯ç‚¹ç¯ ï¼† çŠ¶æ…‹å®‰å®š");
    Serial.println("=====================================");
  } else if(!shouldMeasure && measuring) {
    measuring = false;
    unsigned long dur = millis() - measureStart;
    wastedMs += dur;
    hourlyMs += dur;  // fiveMinMs â†’ hourlyMs
    
    // åœæ­¢ç†ç”±ã‚’ç‰¹å®š
    String reason = "";
    if (personPresent) reason = "äººãŒåœ¨å®¤";
    else if (!isFluorescentOn) reason = "è›å…‰ç¯æ¶ˆç¯";
    else if (!lightStateStable) reason = "ç…§æ˜çŠ¶æ…‹ãŒä¸å®‰å®š";
    
    Serial.println("=====================================");
    Serial.printf(">>> ç„¡é§„ç‚¹ç¯æ¸¬å®šçµ‚äº† <<<\n");
    Serial.printf("ç†ç”±: %s | ç¶™ç¶šæ™‚é–“: %s\n", reason.c_str(), formatTime(dur).c_str());
    Serial.println("=====================================");
  }

  // 1ç§’ã”ã¨ã®å‡¦ç†
  static unsigned long lastPrint = 0;
  if(millis() - lastPrint >= 1000) {
    lastPrint = millis();

    unsigned long currentMs = wastedMs + (measuring?(millis()-measureStart):0);
    unsigned long currentHourlyMs = hourlyMs + (measuring?(millis()-measureStart):0);  // fiveMinMs â†’ hourlyMs

    unsigned long wastedHourlySeconds = currentHourlyMs / 1000;  // 1æ™‚é–“ã®ç„¡é§„ç§’æ•°ã‚’è¨ˆç®—

    // ç¾åœ¨æ™‚åˆ»
    time_t now;
    struct tm timeinfo;
    time(&now);
    localtime_r(&now,&timeinfo);

    int currentHour = timeinfo.tm_hour;
    int currentMin = timeinfo.tm_min;
    int currentDay = timeinfo.tm_mday;

    // 1æ™‚é–“ãŒå¤‰ã‚ã£ãŸã‚‰ç¢ºå®š
    if(lastHour != -1 && currentHour != lastHour) {
      Serial.printf("[é›†è¨ˆ] %02dæ™‚å°ã®ç„¡é§„æ™‚é–“: %s | ç„¡é§„ç§’æ•°: %luç§’\n",
        lastHour,  // å‰ã®æ™‚é–“
        formatTime(currentHourlyMs).c_str(),
        wastedHourlySeconds
      );
      
      // ç„¡é§„ç§’æ•°ã‚’floatã¨ã—ã¦é€ä¿¡ï¼ˆAPIä»•æ§˜ã«åˆã‚ã›ã‚‹ãŸã‚ï¼‰
      sendUsageData(deviceId, "electricity", (float)wastedHourlySeconds, "aquarium-esp32-secure-key-2024");
      
      // æ—¥æ¬¡ç´¯è¨ˆã«è¿½åŠ 
      float wastedHourly_h = currentHourlyMs / 3600000.0;
      float wastedKWh_hourly = wastedHourly_h * LIGHT_POWER_W / 1000.0;
      dailyTotalKWh += wastedKWh_hourly;
      dailyTotalMs += currentHourlyMs;
      
      hourlyMs = 0;  // æ¬¡ã®1æ™‚é–“ã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
    }

    // ç¾åœ¨æ™‚åˆ»è¨˜éŒ²
    lastHour = currentHour;
    lastDay = currentDay;
    
    // ç¾åœ¨ã®ç…§åº¦å€¤ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    float currentLux = lightMeter.readLightLevel();
    
    // çŠ¶æ…‹ã‚’å‡ºåŠ›ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ–¹å¼ã®è©³ç´°çŠ¶æ…‹ã‚‚è¡¨ç¤ºï¼‰
    String nowClock = formatTime(millis());
    unsigned long timeSinceDetection = millis() - lastPersonDetectedMs;
    
    Serial.print("æ™‚åˆ»: "); Serial.print(nowClock);
    Serial.print(" | ç…§åº¦: "); Serial.printf("%.1f lux", currentLux);
    Serial.print(" | è›å…‰ç¯: "); Serial.print(isFluorescentOn ? "ç‚¹ç¯" : "æ¶ˆç¯");
    Serial.print(" | å®‰å®š: "); Serial.print(lightStateStable ? "â—‹" : "Ã—");
    Serial.print(" | PIR: "); Serial.print(pirState == HIGH ? "æ¤œå‡º" : "ãªã—");
    Serial.print(" | äºº: "); Serial.print(personPresent ? "åœ¨å®¤" : "ä¸åœ¨");
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæƒ…å ±ã®è¡¨ç¤º
    if (personPresent && personTimeoutEnabled) {
      unsigned long timeoutRemaining = PERSON_TIMEOUT_MS - timeSinceDetection;
      if (timeoutRemaining > 0) {
        Serial.printf(" (æ®‹ã‚Š%luåˆ†)", timeoutRemaining / 60000);
      }
    } else if (personPresent && !personTimeoutEnabled) {
      Serial.print(" (æ‰‹å‹•)");
    }
    
    Serial.print(" | æ¸¬å®š: "); Serial.print(measuring ? "å®Ÿè¡Œä¸­" : "åœæ­¢ä¸­");
    Serial.print(" | ç„¡é§„æ™‚é–“(1æ™‚é–“): "); Serial.print(formatTime(currentHourlyMs));
    Serial.print(" | ç„¡é§„ç§’æ•°(1æ™‚é–“): "); Serial.printf("%luç§’", wastedHourlySeconds);
    Serial.print(" | ç™»éŒ²ã‚³ãƒ¼ãƒ‰: "); Serial.println(registrationCode);
  }
}
